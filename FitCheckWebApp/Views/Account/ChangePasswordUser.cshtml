@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/css/ChangePasswordUser.css" asp-append-version="true" />
    <link rel="icon" href="~/images_fitcheck/fitcheckicon.png" />
    <title>Change Password | FitCheck Gym</title>
</head>
<body>
    <header>
        <div class="brand-container">
            <img asp-append-version="true" src="~/images_fitcheck/fitcheckicon.png" alt="logo" class="logo" />
            <h1 class="brand">FITCHECK</h1>
        </div>

        <nav class="navbar">
            <a asp-controller="Account" asp-action="AccountUser" class="back-link">
                <i data-lucide="arrow-left"></i>
                <span>Back</span>
            </a>
        </nav>
    </header>

    <main>
        <h2 class="page-title">CHANGE PASSWORD</h2>
        <section class="form-section">
            <form id="changePasswordForm" class="form">
                <input type="password" id="currentPassword" placeholder="Current Password" class="input-field full" required>
                <a href="#" class="forgot-password" onclick="event.preventDefault(); openForgotPasswordFlow()">
                    <p>Forgot Password?</p>
                </a>
                <input type="password" id="newPassword" placeholder="New Password" class="input-field full" required>
                <input type="password" id="confirmPassword" placeholder="Confirm New Password" class="input-field full" required>

                <div class="button-group">
                    <button type="submit" class="btn-change">CHANGE PASSWORD</button>
                    <a asp-controller="Account" asp-action="AccountUser" class="btn-cancel">CANCEL</a>
                </div>
            </form>
        </section>
    </main>

    <!-- Email Verification Popup -->
    <div id="emailVerificationPopup" class="popup-container">
        <div class="popup">
            <button class="close-btn" onclick="closePopup()">&times;</button>
            <h2 class="popup-title">VERIFY EMAIL</h2>
            <p class="popup-text">To reset your password, verify your email. We sent you a 4-digit code.</p>

            <div class="code-inputs">
                <input type="text" maxlength="1" class="code-box" id="code1" />
                <input type="text" maxlength="1" class="code-box" id="code2" />
                <input type="text" maxlength="1" class="code-box" id="code3" />
                <input type="text" maxlength="1" class="code-box" id="code4" />
            </div>

            <button class="btn-continue" onclick="verifyCode()">CONTINUE</button>
            <p class="resend-text">Didn't get the code? <a href="#" class="resend-link" onclick="event.preventDefault(); resendCode()">Resend</a></p>
        </div>
    </div>

    <!-- Reset Password Popup -->
    <div id="resetPasswordPopup" class="popup-container">
        <div class="popup">
            <button class="close-btn" onclick="closeResetPopup()">&times;</button>
            <h2 class="popup-title">SET NEW PASSWORD</h2>
            <p class="popup-text">Enter your new password below.</p>

            <form id="resetPasswordForm" class="form" style="padding: 20px 0;">
                <input type="password" id="resetNewPassword" placeholder="New Password" class="input-field full" required style="margin-bottom: 15px;">
                <input type="password" id="resetConfirmPassword" placeholder="Confirm New Password" class="input-field full" required>
            </form>

            <button class="btn-continue" onclick="submitPasswordReset()">RESET PASSWORD</button>
        </div>
    </div>

    <script>
        let verifiedCode = '';

        // Change Password with Current Password
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }

            try {
                const response = await fetch('/Account/ChangePassword', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Password changed successfully!');
                    window.location.href = '/Account/AccountUser';
                } else {
                    alert(result.message || 'Failed to change password');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while changing password');
            }
        });

        // Forgot Password Flow
        async function openForgotPasswordFlow() {
            try {
                const response = await fetch('/Account/SendVerificationCode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    openVerificationPopup();
                    alert('Verification code sent to your email!');
                } else {
                    alert(result.message || 'Failed to send verification code');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while sending verification code');
            }
        }

        function openVerificationPopup() {
            document.getElementById("emailVerificationPopup").style.display = "flex";
            document.getElementById('code1').focus();
        }

        function closePopup() {
            document.getElementById("emailVerificationPopup").style.display = "none";
            clearCodeInputs();
        }

        function closeResetPopup() {
            document.getElementById("resetPasswordPopup").style.display = "none";
        }

        // Auto-focus next input
        document.querySelectorAll('.code-box').forEach((input, index, inputs) => {
            input.addEventListener('input', function() {
                if (this.value.length === 1 && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value === '' && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });

        async function verifyCode() {
            const code1 = document.getElementById('code1').value;
            const code2 = document.getElementById('code2').value;
            const code3 = document.getElementById('code3').value;
            const code4 = document.getElementById('code4').value;

            const code = code1 + code2 + code3 + code4;

            if (code.length !== 4) {
                alert('Please enter all 4 digits');
                return;
            }

            try {
                const response = await fetch('/Account/VerifyCode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const result = await response.json();

                if (result.success) {
                    verifiedCode = code;
                    closePopup();
                    document.getElementById("resetPasswordPopup").style.display = "flex";
                } else {
                    alert(result.message || 'Invalid or expired code');
                    clearCodeInputs();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while verifying code');
            }
        }

        async function submitPasswordReset() {
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }

            try {
                const response = await fetch('/Account/ResetPasswordWithCode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: verifiedCode,
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Password reset successfully!');
                    closeResetPopup();
                    window.location.href = '/Account/AccountUser';
                } else {
                    alert(result.message || 'Failed to reset password');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while resetting password');
            }
        }

        async function resendCode() {
            try {
                const response = await fetch('/Account/SendVerificationCode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('New verification code sent!');
                    clearCodeInputs();
                } else {
                    alert(result.message || 'Failed to resend code');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while resending code');
            }
        }

        function clearCodeInputs() {
            document.getElementById('code1').value = '';
            document.getElementById('code2').value = '';
            document.getElementById('code3').value = '';
            document.getElementById('code4').value = '';
            document.getElementById('code1').focus();
        }


        window.addEventListener('load', function () {
            document.getElementById("emailVerificationPopup").style.display = "none";
            document.getElementById("resetPasswordPopup").style.display = "none";
        });
    </script>

    <div class="hr-container">
        <hr>
    </div>

    <footer>
        <div class="footer-container">
            <div class="left-side-footer">
                <div class="description-footer">
                    <img class="fitcheck-logo-footer" src="~/images_fitcheck/fitcheckicon.png">
                    <p>Transform your body and mind at FitCheck Gym. With state-of-the-art equipment, expert trainers, and a supportive community, we're here to help you achieve your fitness goals.</p>
                </div>
                <div class="follow-socials-container">
                    <h4 class="follow-us-footer">FOLLOW US</h4>
                    <div class="social-media-container">
                        <a target="_blank" href="https://www.facebook.com/"><img src="~/images_fitcheck/icon_fb-removebg-preview.png"></a>
                        <a target="_blank" href="https://www.linkedin.com/"><img src="~/images_fitcheck/Icon_linkedin-removebg-preview.png"></a>
                        <a target="_blank" href="https://www.youtube.com/"><img src="~/images_fitcheck/icon_youtube-removebg-preview.png"></a>
                        <a target="_blank" href="https://www.instagram.com/"><img src="~/images_fitcheck/icon_instagram-removebg-preview.png"></a>
                    </div>
                </div>
            </div>
            <div class="right-side-footer">
                <div class="address">
                    <img src="~/images_fitcheck/icon_location-removebg-preview.png">
                    <p>Street 1, Congressional Rd Caloocan City</p>
                </div>
                <div class="email-address">
                    <img src="~/images_fitcheck/icon_email-removebg-preview.png">
                    <p>info@fitcheckgym.com</p>
                </div>
                <div class="contact-number">
                    <img src="~/images_fitcheck/icon_mobile-removebg-preview.png">
                    <p>09192344890 / 09365144587</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://unpkg.com/lucide@0.268.0/dist/umd/lucide.min.js"></script>
    <script>
        lucide.createIcons();
    </script>

</body>
</html>