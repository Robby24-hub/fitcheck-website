@model List<FitCheckWebApp.Models.Class>
@{
    Layout = null;
    var trainers = ViewBag.Trainers as List<FitCheckWebApp.Models.Account>;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Classes | FitCheck Gym</title>
    <link rel="stylesheet" href="~/css/AdminClass.css" asp-append-version="true" />
</head>
<body>
    <header>
        <div class="brand-container">
            <img alt="logo" class="logo" src="~/images_fitcheck/fitcheckicon.png">
            <h1 class="brand">FITCHECK</h1>
        </div>
        <nav class="navbar">
            <a asp-controller="Admin" asp-action="AdminHome">Home</a>
            <a asp-controller="Admin" asp-action="AdminPayment">Payment</a>
            <a asp-controller="Admin" asp-action="AdminClass">Classes</a>
            <a asp-controller="Admin" asp-action="AdminMember">Members</a>
            <form asp-controller="Account" asp-action="Logout" method="post" style="display:inline;">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </nav>
    </header>

    <main>

        @if (TempData["SuccessMessage"] != null)
        {
            <div style="background: #d4edda; color: #155724; padding: 15px; margin: 10px 0; border: 1px solid #c3e6cb; border-radius: 5px;">
                @TempData["SuccessMessage"]
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div style="background: #f8d7da; color: #721c24; padding: 15px; margin: 10px 0; border: 1px solid #f5c6cb; border-radius: 5px;">
                @TempData["ErrorMessage"]
            </div>
        }

        <h2>WELCOME Admin,</h2>
        <h3>CLASS OVERVIEW</h3>
        <button id="openAddFormBtn" class="submit-btn">ADD CLASS</button>

        <div class="table-container">
            <table aria-describedby="class-overview">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Instructor</th>
                        <th>Type</th>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Participants</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var c in Model)
                        {
                            <tr data-id="@c.Id"
                                data-accountid="@c.AccountID"
                                data-day="@c.Day"
                                data-type="@c.Type"
                                data-time="@c.Time"
                                data-duration="@c.DurationMinutes"
                                data-limit="@c.ParticipantLimit"
                                data-count="@c.ParticipantsCount">
                                <td>@c.Day</td>
                                <td>@(c.InstructorName ?? "Unassigned")</td>
                                <td>@c.Type</td>
                                <td>@(TimeSpanTo12Hour(c.Time))</td>
                                <td>@c.DurationMinutes min</td>
                                <td>@c.ParticipantsCount / @c.ParticipantLimit</td>
                                <td>
                                    <button class="edit-btn" onclick="openEditForm(@c.Id)">Edit</button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" style="text-align: center;">No classes available</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </main>

    <!-- ADD CLASS POPUP -->
    <div class="popup-overlay" id="addPopupForm">
        <div class="popup">
            <h3>ADD CLASS</h3>
            <form id="addClassForm" method="post" asp-action="AddClass">
                <input type="hidden" name="ParticipantsCount" value="0" />

                <label>Instructor</label>
                <select name="AccountID" required>
                    <option value="" disabled selected>Select instructor</option>
                    @if (trainers != null && trainers.Any())
                    {
                        foreach (var t in trainers)
                        {
                            <option value="@t.Id">@t.FirstName @t.LastName</option>
                        }
                    }
                    else
                    {
                        <option disabled>No trainers available</option>
                    }
                </select>

                <label>Type</label>
                <select name="Type" required>
                    <option value="" disabled selected>Select class type</option>
                    <option value="Yoga">Yoga</option>
                    <option value="Zumba">Zumba</option>
                    <option value="Pilates">Pilates</option>
                    <option value="CrossFit">CrossFit</option>
                    <option value="HIIT">HIIT</option>
                    <option value="StrengthTraining">Strength Training</option>
                    <option value="Cardio">Cardio</option>
                    <option value="DanceFitness">Dance Fitness</option>
                </select>

                <label>Day</label>
                <select name="Day" required>
                    <option value="" disabled selected>Select day</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>

                <label>Time</label>
                <input type="time" name="Time" required />

                <label>Duration (minutes)</label>
                <select name="DurationMinutes" required>
                    <option value="" disabled selected>Select duration</option>
                    <option value="30">30</option>
                    <option value="45">45</option>
                    <option value="60">60</option>
                    <option value="75">75</option>
                    <option value="90">90</option>
                </select>

                <label>Participant Limit</label>
                <select name="ParticipantLimit" required>
                    <option value="" disabled selected>Select limit</option>
                    @for (int i = 5; i <= 30; i += 5)
                    {
                        <option value="@i">@i</option>
                    }
                </select>

                <button type="submit" class="submit-btn">ADD CLASS</button>
            </form>
            <span class="close-btn" id="closeAddBtn">&times;</span>
        </div>
    </div>

    <!-- EDIT CLASS POPUP -->
    <div class="popup-overlay" id="editPopupForm">
        <div class="popup">
            <h3>EDIT CLASS</h3>
            <form id="editClassForm" method="post" asp-action="EditClass">
                <input type="hidden" id="editId" name="Id" />
                <input type="hidden" id="editParticipantsCount" name="ParticipantsCount" />

                <label>Instructor</label>
                <select id="editAccountID" name="AccountID" required>
                    <option value="" disabled>Select instructor</option>
                    @if (trainers != null && trainers.Any())
                    {
                        foreach (var t in trainers)
                        {
                            <option value="@t.Id">@t.FirstName @t.LastName</option>
                        }
                    }
                </select>

                <label>Type</label>
                <select id="editType" name="Type" required>
                    <option value="" disabled>Select class type</option>
                    <option value="Yoga">Yoga</option>
                    <option value="Zumba">Zumba</option>
                    <option value="Pilates">Pilates</option>
                    <option value="CrossFit">CrossFit</option>
                    <option value="HIIT">HIIT</option>
                    <option value="StrengthTraining">Strength Training</option>
                    <option value="Cardio">Cardio</option>
                    <option value="DanceFitness">Dance Fitness</option>
                </select>

                <label>Day</label>
                <select id="editDay" name="Day" required>
                    <option value="" disabled>Select day</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>

                <label>Time</label>
                <input type="time" id="editTime" name="Time" required />

                <label>Duration (minutes)</label>
                <select id="editDuration" name="DurationMinutes" required>
                    <option value="" disabled>Select duration</option>
                    <option value="30">30</option>
                    <option value="45">45</option>
                    <option value="60">60</option>
                    <option value="75">75</option>
                    <option value="90">90</option>
                </select>

                <label>Participant Limit</label>
                <select id="editLimit" name="ParticipantLimit" required>
                    <option value="" disabled>Select limit</option>
                    @for (int i = 5; i <= 30; i += 5)
                    {
                        <option value="@i">@i</option>
                    }
                </select>

                <button type="submit" class="submit-btn">UPDATE CLASS</button>
            </form>
            <span class="close-btn" id="closeEditBtn">&times;</span>
        </div>
    </div>

    @functions {
        private string TimeSpanTo12Hour(TimeSpan t)
        {
            int h = t.Hours % 12;
            if (h == 0) h = 12;
            string ampm = t.Hours >= 12 ? "PM" : "AM";
            return $"{h}:{t.Minutes:D2} {ampm}";
        }
    }

    <script>
        // Add Class Popup
        const openAddBtn = document.getElementById('openAddFormBtn');
        const addPopup = document.getElementById('addPopupForm');
        const closeAddBtn = document.getElementById('closeAddBtn');

        openAddBtn.addEventListener('click', () => addPopup.style.display = 'flex');
        closeAddBtn.addEventListener('click', () => addPopup.style.display = 'none');

        // Edit Class Popup
        const editPopup = document.getElementById('editPopupForm');
        const closeEditBtn = document.getElementById('closeEditBtn');

        closeEditBtn.addEventListener('click', () => editPopup.style.display = 'none');

        // Close on overlay click
        window.addEventListener('click', e => {
            if (e.target === addPopup) addPopup.style.display = 'none';
            if (e.target === editPopup) editPopup.style.display = 'none';
        });

        // Open Edit Form with data
        function openEditForm(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);

            if (!row) {
                alert('Error: Could not find class data');
                return;
            }

            document.getElementById('editId').value = id;
            document.getElementById('editAccountID').value = row.dataset.accountid;
            document.getElementById('editDay').value = row.dataset.day;
            document.getElementById('editType').value = row.dataset.type;
            document.getElementById('editTime').value = row.dataset.time;
            document.getElementById('editDuration').value = row.dataset.duration;
            document.getElementById('editLimit').value = row.dataset.limit;
            document.getElementById('editParticipantsCount').value = row.dataset.count;

            editPopup.style.display = 'flex';
        }
    </script>
</body>
</html>