@using FitCheckWebApp.ViewModels.Transaction
@{
    Layout = null;
}

@model TransactionViewModel

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/css/PaymentMethod.css" asp-append-version="true" />
    <link rel="icon" href="~/images_fitcheck/fitcheckicon.png" />
    <title>Select Payment Method | FitCheck Gym</title>
</head>
<body>
    <header>
        <div class="brand-container">
            <img asp-append-version="true" src="~/images_fitcheck/fitcheckicon.png" alt="logo" class="logo" />
            <h1 class="brand">FITCHECK</h1>
        </div>

        <nav class="navbar">
            <a asp-controller="Account" asp-action="UserHome">Home</a>
            <a asp-controller="Transaction" asp-action="UserMembership">Membership</a>
            <a asp-controller="Account" asp-action="ClassesUser">Classes</a>
            <a asp-controller="Account" asp-action="Products">Products</a>
            <a asp-controller="Account" asp-action="AccountUser">Account</a>
            <form method="post" style="display:inline;">
                <button type="button" class="logout-btn" onclick="openLogoutModal()">Logout</button>
            </form>
        </nav>
    </header>

    <main class="container">
        <h1 class="page-title">Select Payment Method</h1>

        @* Show upgrade banner if this is an upgrade *@
        @if (Model.IsUpgrade)
        {
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; margin: 20px auto; border-radius: 12px; text-align: center; max-width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 15px 0; font-size: 24px;">üéâ Upgrading Your Membership</h3>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 5px 0; font-size: 18px;">
                        <strong>@Model.CurrentPlan</strong> ‚Üí <strong>@Model.MembershipPlan</strong>
                    </p>
                </div>
                <p style="margin: 15px 0 5px 0; font-size: 28px; font-weight: bold;">
                    ‚Ç±@Model.Amount.ToString("N2")
                </p>
                <small style="opacity: 0.9;">Prorated upgrade cost based on remaining days</small>
            </div>
        }

        <section class="grid">
            <a class="card" href="#" aria-label="Pay with Mastercard" onclick="showPaymentForm('mastercard')">
                <img src="~/images_fitcheck/Mastercard.png" alt="Mastercard" width="306" height="228" />
            </a>
            <a class="card" href="#" aria-label="Pay with GCash" onclick="showPaymentForm('gcash')">
                <img src="~/images_fitcheck/Gcash.png" alt="GCash" width="306" height="228" />
            </a>
            <a class="card" href="#" aria-label="Pay with Pay Cash" onclick="showPaymentForm('paycash')">
                <img src="~/images_fitcheck/Paycash.png" alt="Pay Cash" width="306" height="228" />
            </a>
        </section>
    </main>

    <!-- Modal for Payment Form -->
    <div id="paymentModal" class="payment-modal">
        <div class="payment-modal-content">
            <span class="close-btn" onclick="closePaymentForm()">&times;</span>
            <h2>Payment Details</h2>
            <form asp-controller="Transaction" asp-action="PaymentMethod" method="post" id="paymentForm">
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="PaymentMethod" id="paymentMethod" value="" />
                <input type="hidden" asp-for="MembershipPlan" id="hiddenMembershipPlan" />
                <input type="hidden" asp-for="IsUpgrade" />
                <input type="hidden" asp-for="Amount" />

                <div asp-validation-summary="All" class="validation-summary"></div>

                <div class="form-row">
                    <div class="input-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" asp-for="FirstName" required
                               pattern="[a-zA-Z\s]+" title="Only letters and spaces are allowed"
                               maxlength="50">
                        <span asp-validation-for="FirstName" class="field-validation-error"></span>
                    </div>
                    <div class="input-group">
                        <label for="surname">Surname</label>
                        <input type="text" id="surname" name="surname" asp-for="Surname" required
                               pattern="[a-zA-Z\s]+" title="Only letters and spaces are allowed"
                               maxlength="50">
                        <span asp-validation-for="Surname" class="field-validation-error"></span>
                    </div>
                </div>

                <!-- Dynamic Fields Based on Payment Method -->
                <div class="form-row" id="dynamicFields"></div>

                <!-- Membership Plan Display -->
                <div class="form-row">
                    <label for="membershipPlanDisplay">Membership Plan:</label>
                    @if (Model.IsUpgrade)
                    {
                        <input type="text" id="membershipPlanDisplay" value="@Model.MembershipPlan (Upgrade)" readonly style="background: #f3f4f6; cursor: not-allowed; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; width: 100%;">
                    }
                    else
                    {
                        <select asp-for="MembershipPlan" id="membershipPlanSelect" required onchange="updatePrice()">
                            <option value="" disabled selected>Select a plan</option>
                            <option value="FitStart" data-price="999">FitStart ‚Äî ‚Ç±999</option>
                            <option value="FitPro" data-price="1499">FitPro ‚Äî ‚Ç±1,499</option>
                            <option value="FitElite" data-price="2499">FitElite ‚Äî ‚Ç±2,499</option>
                        </select>
                        <span asp-validation-for="MembershipPlan" class="field-validation-error"></span>
                    }
                </div>

                <div class="form-row">
                    <label>
                        @if (Model.IsUpgrade)
                        {
                            <strong style="color: #7c3aed;">Upgrade Cost:</strong>
                        }
                        else
                        {
                            <strong>Price:</strong>
                        }
                    </label>
                    <span id="membershipPriceValue" style="font-size: 24px; font-weight: bold; color: @(Model.IsUpgrade ? "#7c3aed" : "#059669");">
                        ‚Ç±@Model.Amount.ToString("N2")
                    </span>
                </div>

                @if (Model.IsUpgrade)
                {
                    <div class="form-row">
                        <p style="color: #7c3aed; font-size: 14px; text-align: center; background: #f3e8ff; padding: 10px; border-radius: 5px;">
                            ‚úì Prorated amount - You only pay the difference!
                        </p>
                    </div>
                }

                <div class="form-row">
                    <p style="color: red; font-size: 14px; text-align: center;">Note: There are no refunds for payments made.</p>
                </div>

                <div class="form-row">
                    <button type="submit" class="pay-btn">
                        @if (Model.IsUpgrade)
                        {
                            <text>Complete Upgrade</text>
                        }
                        else
                        {
                            <text>Pay Now</text>
                        }
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Thank You Message Modal -->
    <div id="thankYouModal" class="payment-modal">
        <div class="payment-modal-content">
            <span class="close-btn" onclick="closeThankYouMessage()">&times;</span>
            <h2>Thank You for @(Model.IsUpgrade ? "Upgrading" : "Subscribing")!</h2>
            <p>Your payment has been successfully processed. @(Model.IsUpgrade ? "Your membership has been upgraded!" : "We appreciate your subscription to FitCheck!")</p>
            <a asp-controller="Transaction" asp-action="UserMembership" style="display: inline-block; margin-top: 15px; padding: 10px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                Back to Membership
            </a>
        </div>
    </div>

    <script>
        // Initialize page
        window.onload = function() {
            const isUpgrade = @(Model.IsUpgrade.ToString().ToLower());
            const planValue = '@Model.MembershipPlan';
            const amount = @Model.Amount;

            if (!isUpgrade) {
                // For regular subscriptions, set the selected plan
                const membershipSelect = document.getElementById('membershipPlanSelect');
                if (membershipSelect && planValue) {
                    for (let option of membershipSelect.options) {
                        if (option.value === planValue) {
                            option.selected = true;
                            break;
                        }
                    }
                }
            }

            // Set hidden field
            document.getElementById('hiddenMembershipPlan').value = planValue;
        };

        function updatePrice() {
            const membershipSelect = document.getElementById('membershipPlanSelect');
            const selectedOption = membershipSelect.options[membershipSelect.selectedIndex];
            const price = selectedOption.getAttribute('data-price');

            document.getElementById('membershipPriceValue').textContent = '‚Ç±' + price;
            document.getElementById('hiddenMembershipPlan').value = selectedOption.value;
        }

                function showPaymentForm(paymentMethod) {
            const modal = document.getElementById("paymentModal");
            modal.style.display = "block";

            const hiddenPayment = document.getElementById("paymentMethod");
            const dynamicFields = document.getElementById("dynamicFields");

            if (paymentMethod === 'mastercard') {
                hiddenPayment.value = "Credit";
                dynamicFields.innerHTML = `
                    <div class="form-row">
                        <div class="input-group">
                            <label for="cardNumber">Card Number</label>
                            <input type="text" id="cardNumber" name="cardNumber" asp-for="CardNumber"
                                   maxlength="19" required pattern="[0-9\s]{13,19}"
                                   title="Enter a valid credit card number (13-19 digits)"
                                   oninput="formatCardNumber(this)" placeholder="1234 5678 9012 3456">
                            <span asp-validation-for="CardNumber" class="field-validation-error"></span>
                        </div>
                        <div class="input-group">
                            <label for="cardHolderName">Cardholder Name</label>
                            <input type="text" id="cardHolderName" name="cardHolderName" asp-for="CardHolderName"
                                   required pattern="[a-zA-Z\s]+" title="Only letters and spaces are allowed"
                                   maxlength="100" placeholder="John Doe">
                            <span asp-validation-for="CardHolderName" class="field-validation-error"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" name="cvv" asp-for="CVV"
                                   maxlength="3" required pattern="[0-9]{3}"
                                   title="CVV must be exactly 3 digits" placeholder="123">
                            <span asp-validation-for="CVV" class="field-validation-error"></span>
                        </div>
                        <div class="input-group">
                            <label for="validity">Expiry (MM/YY)</label>
                            <input type="text" id="validity" name="validity" asp-for="Validity"
                                   placeholder="MM/YY" maxlength="5" required
                                   pattern="(0[1-9]|1[0-2])\/([0-9]{2})"
                                   title="Enter expiry date in MM/YY format"
                                   oninput="formatExpiryDate(this)">
                            <span asp-validation-for="Validity" class="field-validation-error"></span>
                        </div>
                    </div>`;
            } else if (paymentMethod === 'gcash') {
                hiddenPayment.value = "Debit";
                dynamicFields.innerHTML = `
                    <div class="form-row">
                        <div class="input-group">
                            <label for="accountNumber">GCash Number</label>
                            <input type="tel" id="accountNumber" name="accountNumber" asp-for="AccountNumber"
                                   placeholder="09XXXXXXXXX" maxlength="11" required
                                   pattern="(09|\+639)\d{9}"
                                   title="Enter your 11-digit GCash number (09XXXXXXXXX)"
                                   oninput="formatPhilippineNumber(this, 'gcash')">
                            <small style="display: block; margin-top: 5px; color: #6b7280; font-size: 12px;">
                                Format: 09XXXXXXXXX (11 digits)
                            </small>
                            <span asp-validation-for="AccountNumber" class="field-validation-error"></span>
                        </div>
                    </div>`;
            } else if (paymentMethod === 'paycash') {
                hiddenPayment.value = "Cash";
                dynamicFields.innerHTML = `
                    <div class="form-row">
                        <div class="input-group">
                            <label for="cellphoneNumber">Cellphone Number</label>
                            <input type="tel" id="cellphoneNumber" name="cellphoneNumber" asp-for="CellphoneNumber"
                                   placeholder="09XXXXXXXXX or 9XXXXXXXXX" maxlength="11" required
                                   pattern="(09|\+639|9)\d{9}"
                                   title="Enter your Philippine mobile number (09XXXXXXXXX, +639XXXXXXXXX, or 9XXXXXXXXX)"
                                   oninput="formatPhilippineNumber(this, 'paycash')">
                            <small style="display: block; margin-top: 5px; color: #6b7280; font-size: 12px;">
                                Format: 09XXXXXXXXX, +639XXXXXXXXX, or 9XXXXXXXXX
                            </small>
                            <span asp-validation-for="CellphoneNumber" class="field-validation-error"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <p style="color: #f59e0b; font-weight: bold; text-align: center; background: #fef3c7; padding: 10px; border-radius: 5px;">
                            ‚ö†Ô∏è Go to the nearest FitCheck branch to complete the payment.
                        </p>
                    </div>`;
            }


            clearValidationMessages();
        }

        function formatCardNumber(input) {
            // Remove all non-digits
            let value = input.value.replace(/\D/g, '');

            // Add spaces every 4 digits
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');

            input.value = value;
        }

        function formatExpiryDate(input) {
            let value = input.value.replace(/\D/g, '');

            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }

            input.value = value;
        }

                function formatPhilippineNumber(input, type) {
            let value = input.value.replace(/\D/g, '');

            // Remove leading zeros except for the pattern
            if (value.startsWith('0') && value.length > 1) {
                value = value.substring(1);
            }

            // Handle different formats
            if (type === 'gcash') {
                // GCash must start with 9 and be 10 digits (without 0)
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }

                // Auto-format as user types
                if (value.length <= 10) {
                    input.value = value;
                }

            } else if (type === 'paycash') {
                // Regular Philippine number - can be 10 digits (9XXXXXXXXX)
                // or 11 digits (09XXXXXXXXX)
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }

                input.value = value;
            }

            // Real-time validation feedback
            validatePhilippineNumber(input, type);
        }

        function validatePhilippineNumber(input, type) {
            const value = input.value.replace(/\D/g, '');
            let isValid = false;

            if (type === 'gcash') {
                // GCash: 09 + 9 digits or 9 + 9 digits (total 10 digits without 0)
                isValid = /^9\d{9}$/.test(value) && value.length === 10;
            } else if (type === 'paycash') {
                // Philippine mobile: 9 + 9 digits (10 digits total)
                isValid = /^9\d{9}$/.test(value) && value.length === 10;
            }

            if (value && !isValid) {
                input.style.borderColor = '#ef4444';
                input.style.backgroundColor = '#fef2f2';
            } else if (value && isValid) {
                input.style.borderColor = '#86efac';
                input.style.backgroundColor = '#f0fdf4';
            } else {
                input.style.borderColor = '#d1d5db';
                input.style.backgroundColor = 'white';
            }
        }

        function clearValidationMessages() {
            const errorSpans = document.querySelectorAll('.field-validation-error');
            errorSpans.forEach(span => span.textContent = '');

            const validationSummary = document.querySelector('.validation-summary');
            if (validationSummary) {
                validationSummary.innerHTML = '';
            }
        }

        function closePaymentForm() {
            document.getElementById("paymentModal").style.display = "none";
        }

        function closeThankYouMessage() {
            document.getElementById("thankYouModal").style.display = "none";
            window.location.href = '@Url.Action("UserMembership", "Transaction")';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById("paymentModal");
            if (event.target == modal) {
                closePaymentForm();
            }
        }

                function validateForm() {
            let isValid = true;
            clearValidationMessages();

            // Validate required fields
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    showFieldError(field, 'This field is required');
                    isValid = false;
                }
            });

            // Validate Philippine numbers specifically
            const gcashField = document.getElementById('accountNumber');
            if (gcashField && gcashField.value) {
                const gcashValue = gcashField.value.replace(/\D/g, '');
                if (!/^9\d{9}$/.test(gcashValue)) {
                    showFieldError(gcashField, 'Please enter a valid 11-digit GCash number (09XXXXXXXXX)');
                    isValid = false;
                }
            }

            const cellphoneField = document.getElementById('cellphoneNumber');
            if (cellphoneField && cellphoneField.value) {
                const cellValue = cellphoneField.value.replace(/\D/g, '');
                if (!/^9\d{9}$/.test(cellValue)) {
                    showFieldError(cellphoneField, 'Please enter a valid Philippine mobile number (09XXXXXXXXX or 9XXXXXXXXX)');
                    isValid = false;
                }
            }

            // Validate other patterns
            const patternFields = form.querySelectorAll('[pattern]');
            patternFields.forEach(field => {
                if (field.id !== 'accountNumber' && field.id !== 'cellphoneNumber') {
                    const pattern = new RegExp(field.pattern);
                    if (field.value && !pattern.test(field.value.replace(/\s/g, ''))) {
                        showFieldError(field, field.title);
                        isValid = false;
                    }
                }
            });

            return isValid;
        }

        function showFieldError(field, message) {
            const errorSpan = field.parentNode.querySelector('.field-validation-error');
            if (errorSpan) {
                errorSpan.textContent = message;
            }
            field.style.borderColor = '#ef4444';
        }

    </script>

    <div class="hr-container">
        <hr>
    </div>

    <footer>
        <div class="footer-container">
            <div class="left-side-footer">
                <div class="description-footer">
                    <img class="fitcheck-logo-footer" src="~/images_fitcheck/fitcheckicon.png">
                    <p>Transform your body and mind at FitCheck Gym. With state-of-the-art equipment, expert trainers, and a supportive community, we're here to help you achieve your fitness goals.</p>
                </div>
                <div class="follow-socials-container">
                    <h4 class="follow-us-footer">FOLLOW US</h4>
                    <div class="social-media-container">
                        <a target="_blank" href="https://www.facebook.com/"><img src="~/images_fitcheck/icon_fb-removebg-preview.png"></a>
                        <a target="_blank" href="https://www.linkedin.com/"><img src="~/images_fitcheck/Icon_linkedin-removebg-preview.png"></a>
                        <a target="_blank" href="https://www.youtube.com/"><img src="~/images_fitcheck/icon_youtube-removebg-preview.png"></a>
                        <a target="_blank" href="https://www.instagram.com/"><img src="~/images_fitcheck/icon_instagram-removebg-preview.png"></a>
                    </div>
                </div>
            </div>
            <div class="right-side-footer">
                <div class="address">
                    <img src="~/images_fitcheck/icon_location-removebg-preview.png">
                    <p>Street 1, Congressional Rd Caloocan City</p>
                </div>
                <div class="email-address">
                    <img src="~/images_fitcheck/icon_email-removebg-preview.png">
                    <p>info@fitcheckgym.com</p>
                </div>
                <div class="contact-number">
                    <img src="~/images_fitcheck/icon_mobile-removebg-preview.png">
                    <p>09192344890 / 09365144587</p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>